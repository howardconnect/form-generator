<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KCTCS Lab Doc (JSON-backed)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --deep-blue: rgb(0,40,90); --gray:#cdd6e3; --max: 900px; }
  body { font-family:"Inter",system-ui,sans-serif; color:#111; margin:0; padding:24px; }
  .container { max-width: var(--max); margin: 0 auto; }
  h1,h2,h3 { color: var(--deep-blue); margin: 0.6em 0 0.35em; }
  h1 { border-bottom:2px solid var(--gray); padding-bottom:0.3em; }
  label { display:block; margin-top:0.75rem; font-weight:600; }
  select,input,button { width:100%; font:inherit; padding:0.55rem; border:1px solid #bbb; border-radius:6px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  .btns { display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.75rem; }
  button.primary { background: var(--deep-blue); color:#fff; border:none; font-weight:700; }
  #output { margin-top: 1rem; border:1px solid #ccc; border-radius:8px; padding:1rem 1.25rem; background:#fafafa; }
  .meta { color:#333; }
  .error { margin-top: 0.5rem; color:#a40000; font-weight:700; }
</style>
</head>
<body>
<div class="container">
  <h1>Lab Document (JSON-backed)</h1>

  <div id="loadError" class="error" hidden></div>

  <label>Course
    <select id="course">
      <option>BIO 137 — Human Anatomy & Physiology I</option>
      <option>BIO 139 — Human Anatomy & Physiology II</option>
      <option selected>BIO 153 — Principles of Biology II Lab</option>
    </select>
  </label>

  <div class="row">
    <label>Instructor <input id="instructor" value="Justin N. Howard" /></label>
    <label>Lab Title <input id="labtitle" value="Two-Point Discrimination" /></label>
  </div>

  <div class="row">
    <label>Date Assigned <input type="date" id="dateAssigned" /></label>
    <label>Due Date <input type="date" id="dueDate" /></label>
  </div>

  <!-- These will be filled from JSON -->
  <label>Overview <select id="overview"></select></label>
  <label>Objectives <select id="objectives"></select></label>
  <label>Background <select id="background"></select></label>

  <div id="err" class="error" role="alert" aria-live="polite"></div>

  <div class="btns">
    <button type="button" id="render" class="primary">Render</button>
  </div>

  <section id="output" hidden></section>
</div>

<script>
  // Basic markdown -> HTML (bold/italic only; swap for a parser later)
  function mdToHtml(md){
    return (md || "")
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.+?)\*/g,'<em>$1</em>');
  }
  function toOption(label, value){
    const o = document.createElement('option');
    o.textContent = label;
    o.value = value;
    return o;
  }
  function fmt(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr + 'T00:00:00'); // avoid TZ drift
    if(isNaN(d)) return "";
    return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
  }

  // Default dates
  const todayISO = new Date().toISOString().slice(0,10);
  const plus7 = new Date(Date.now() + 7*24*60*60*1000).toISOString().slice(0,10);
  document.getElementById('dateAssigned').value = todayISO;
  document.getElementById('dueDate').value = plus7;

  // State
  let SNIPS = [];
  let OBJS = [];

  async function safeFetch(path){
    const r = await fetch(path, { cache: 'no-store' });
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${path}`);
    return r.json();
  }

  function currentCourseCode(){
    // "BIO 153 — Principles..." -> "BIO 153"
    return document.getElementById('course').value.split(' — ')[0].trim();
  }

  function populateDropdowns(){
    const course = currentCourseCode();

    const ovwSel = document.getElementById('overview');
    const bkgSel = document.getElementById('background');
    const objSel = document.getElementById('objectives');

    ovwSel.innerHTML = '';
    bkgSel.innerHTML = '';
    objSel.innerHTML = '';

    const overviews = SNIPS.filter(s => s.section === 'overview' && (!s.courses || s.courses.includes(course)));
    const backgrounds = SNIPS.filter(s => s.section === 'background' && (!s.courses || s.courses.includes(course)));
    const objectives = OBJS.filter(o => !o.courses || o.courses.includes(course));

    if (overviews.length === 0) ovwSel.appendChild(toOption('— no overview for this course —', ''));
    else overviews.forEach(s => ovwSel.appendChild(toOption(s.title, s.id)));

    if (backgrounds.length === 0) bkgSel.appendChild(toOption('— no background for this course —', ''));
    else backgrounds.forEach(s => bkgSel.appendChild(toOption(s.title, s.id)));

    if (objectives.length === 0) objSel.appendChild(toOption('— no objectives for this course —', ''));
    else objectives.forEach(o => objSel.appendChild(toOption(o.title, o.id)));
  }

  function byId(arr, id){ return arr.find(x => x.id === id); }

  function buildRendered(){
    const course = document.getElementById('course').value;
    const instructor = document.getElementById('instructor').value.trim();
    const labtitle = document.getElementById('labtitle').value.trim();
    const dateAssigned = document.getElementById('dateAssigned').value;
    const dueDate = document.getElementById('dueDate').value;

    const err = document.getElementById('err');
    err.textContent = '';
    if (dateAssigned && dueDate && new Date(dueDate) < new Date(dateAssigned)) {
      err.textContent = 'Due Date cannot be earlier than Date Assigned.';
      return null;
    }

    const ovwId = document.getElementById('overview').value;
    const bkgId = document.getElementById('background').value;
    const objId = document.getElementById('objectives').value;

    const ovw = byId(SNIPS, ovwId);
    const bkg = byId(SNIPS, bkgId);
    const obj = byId(OBJS, objId);

    const objectivesHtml = obj ? `<ul>${(obj.items || []).map(i=>`<li>${i}</li>`).join('')}</ul>` : '<p>(No objectives selected)</p>';
    const overviewHtml = ovw ? mdToHtml(ovw.body_md) : '(No overview selected)';
    const backgroundHtml = bkg ? mdToHtml(bkg.body_md) : '(No background selected)';

    const meta = `
      <p class="meta">
        <strong>${course}</strong><br>
        Instructor: ${instructor || '—'}
        ${dateAssigned ? `<br><strong>Assigned:</strong> ${fmt(dateAssigned)}` : ``}
        ${dueDate ? ` · <strong>Due:</strong> ${fmt(dueDate)}` : ``}
      </p>
    `;

    return `
      <h2>${labtitle || 'Untitled Activity'}</h2>
      <hr>
      ${meta}
      <h3>Overview</h3>
      <p>${overviewHtml}</p>
      <h3>Objectives</h3>
      ${objectivesHtml}
      <h3>Background</h3>
      <p>${backgroundHtml}</p>
    `;
  }

  // Load JSON on start
  (async function init(){
    const errorBox = document.getElementById('loadError');
    try {
      console.log('Loading JSON…');
      const [snips, objs] = await Promise.all([
        safeFetch('./data/snippets.json'),
        safeFetch('./data/objectives.json')
      ]);
      SNIPS = snips;
      OBJS = objs;
      console.log('Loaded snippets:', SNIPS);
      console.log('Loaded objectives:', OBJS);
      populateDropdowns();
      // Re-filter when course changes
      document.getElementById('course').addEventListener('change', populateDropdowns);
    } catch (e) {
      console.error('Failed to load JSON:', e);
      errorBox.textContent = `Could not load data: ${e.message}. Check folder paths and that you're previewing via a server (Live Preview), not opening the file directly.`;
      errorBox.hidden = false;
    }
  })();

  // Render button
  document.getElementById('render').addEventListener('click', () => {
    const html = buildRendered();
    if (!html) return;
    const out = document.getElementById('output');
    out.innerHTML = html;
    out.hidden = false;
  });
</script>
</body>
</html>
